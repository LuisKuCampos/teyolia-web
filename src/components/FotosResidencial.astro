---
import { Image } from "astro:assets";

// 1. CARGA AUTOMÁTICA
const images = import.meta.glob("../assets/residenciales/*.jpg", { eager: true });
const residencialImages = Object.values(images);
---

<section
  class="py-6 bg-[#F5F5F5] overflow-hidden transition-colors duration-500"
>
  <div class="max-w-7xl mx-auto px-6 mb-12 text-center reveal-element">
    <h1
      class="font-display text-5xl md:text-7xl lg:text-8xl text-primary mb-6 leading-tight"
    >
      Fotos <br />
      <span class="italic font-light text-gray-600">Residenciales</span>
    </h1>

    <p
      class="mt-8 text-sm md:text-base max-w-lg mx-auto text-gray-600 leading-relaxed font-light"
    >
      Una colección curada de texturas, aromas visuales y la belleza efímera de
      la alta cocina. Capturando la esencia de cada ingrediente.
    </p>
  </div>
</section>

<section class="bg-[#F5F5F5] overflow-hidden transition-colors duration-500">
  <div
    class="w-full overflow-x-auto snap-x-mandatory pb-12 no-scrollbar px-6 md:px-12"
  >
    <div
      class="grid grid-rows-2 md:grid-rows-3 grid-flow-col gap-4 w-max h-[500px] md:h-[650px] mx-auto"
    >
      {
        residencialImages.map((img: any, index) => {
          const isTall = index % 3 === 0;
          const isWide = index % 3 === 0 && !isTall;

          return (
            <div
              class:list={[
                "lightbox-trigger rounded-3xl overflow-hidden reveal-element group cursor-pointer relative shadow-lg snap-center",
                isTall
                  ? "row-span-2 w-[200px] md:w-[280px]"
                  : isWide
                    ? "w-[300px] md:w-[400px]"
                    : "w-[200px] md:w-[280px]",
              ]}
              style={`transition-delay: ${index * 50}ms;`}
              data-src={img.default.src}
            >
              <Image
                src={img.default}
                alt={`Fotografía gastronómica ${index + 1}`}
                width={600}
                class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
              />
              <div class="absolute inset-0 bg-black/10 group-hover:bg-black/0 transition-colors duration-500 pointer-events-none" />
            </div>
          );
        })
      }
    </div>
  </div>
</section>

<div
  id="lightbox"
  class="fixed inset-0 z-[100] hidden bg-black/95 backdrop-blur-sm flex justify-center items-center opacity-0 transition-opacity duration-300"
>
  <button
    id="lightbox-close"
    class="absolute top-6 right-8 text-white text-5xl hover:text-primary transition-colors cursor-pointer"
    >&times;</button
  >

  <img
    id="lightbox-img"
    src=""
    alt="Vista ampliada"
    class="max-w-[90vw] max-h-[90vh] object-contain rounded-xl shadow-2xl scale-95 transition-transform duration-300"
  />
</div>

<script>
  // Al usar Astro, es buena práctica envolver el script por si usas View Transitions
  document.addEventListener("DOMContentLoaded", () => {
    const lightbox = document.getElementById("lightbox");
    const lightboxImg = document.getElementById(
      "lightbox-img",
    ) as HTMLImageElement;
    const closeBtn = document.getElementById("lightbox-close");
    const triggers = document.querySelectorAll(".lightbox-trigger");

    if (!lightbox || !lightboxImg || !closeBtn) return;

    // Función para abrir la foto
    const openLightbox = (src: string) => {
      lightboxImg.src = src;
      lightbox.classList.remove("hidden");

      // Delay minúsculo para permitir que el CSS aplique la transición suave
      setTimeout(() => {
        lightbox.classList.remove("opacity-0");
        lightboxImg.classList.remove("scale-95");
        lightboxImg.classList.add("scale-100");
      }, 10);

      // Bloqueamos el scroll de la página de fondo
      document.body.style.overflow = "hidden";
    };

    // Función para cerrar la foto
    const closeLightbox = () => {
      lightbox.classList.add("opacity-0");
      lightboxImg.classList.remove("scale-100");
      lightboxImg.classList.add("scale-95");

      setTimeout(() => {
        lightbox.classList.add("hidden");
        lightboxImg.src = ""; // Limpiamos la imagen
      }, 300);

      // Devolvemos el scroll
      document.body.style.overflow = "";
    };

    // Le decimos a cada foto que se abra al darle clic
    triggers.forEach((trigger) => {
      trigger.addEventListener("click", () => {
        const src = trigger.getAttribute("data-src");
        if (src) openLightbox(src);
      });
    });

    // Cerrar si hacen clic en la "X"
    closeBtn.addEventListener("click", closeLightbox);

    // Cerrar si hacen clic en cualquier parte del fondo oscuro
    lightbox.addEventListener("click", (e) => {
      if (e.target === lightbox) closeLightbox();
    });

    // Cerrar si el usuario presiona la tecla "Escape" en su teclado
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && !lightbox.classList.contains("hidden")) {
        closeLightbox();
      }
    });
  });
</script>
